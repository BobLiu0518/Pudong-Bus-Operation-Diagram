var RoadLine="926";var getfirst="";var getlast="";var vn0="";var vn1="";var revid="";$(document).ready(function(){var b=window.location.search;if(b!=""){var a=b.replace("?","").split("&");$(a).each(function(d){var c=a[d].split("=");if(c[0]=="roadline"){RoadLine=c[1]}else{if(c[0]=="user"){if(c[1]!="test"){window.location="guide.htm"}}}if(c[0]=="vid"){revid=c[1]}});if(loadMould()){$("#divNull").hide();Move();setTimeout(TogetAll,1000);setInterval(Move,1000)}else{$("#divNull").show();$("#showModule").hide();$("#loading").fadeOut()}}else{window.location="guide.htm"}});var he1=0;var he2=0;var levelPosition1=[];var levelPosition2=[];function loadMould(){var e=true;var d="";var c="";var a=0;var f=0;var b="ajax/controller.php?Method=station&roadline="+RoadLine;$.ajax({url:b,type:"GET",dataType:"text",async:false,timeout:5000,error:function(){e=false},success:function(m){if(m==null||m==""||m==undefined){$("#RefreshM").show();$("#showModule").hide();$("#loading").fadeOut();e=false}var m=$.parseJSON(m);var h=m.data;if(h.length>0){$("#RoadLine").html(h[0].RoadLine);for(var n=0;n<h.length;n++){if(h[n].Upstream!=""&&h[n].Upstream!=null){if(f==0){getfirst=h[n].ToDirection}f++}else{if(a==0){getlast=h[n].ToDirection}a++}}for(n=0;n<h.length;n++){if(h[n].Upstream!==""&&h[n].Upstream!==null){var l=0;var q=n;var p=h.length-q;if(p>q){l=p}else{l=q}break}}if(l>28){l=(l-28)*35+890}else{if(l<14&&l>2){l=890-(14-l)*10.2*l}else{if(l==2){l=200}else{l=890}}}var o=document.getElementById("stationall");o.style.height=l+"px";he1=parseInt((l-(a-2)*13)/(a-1));he2=parseInt((l-(f-2)*13)/(f-1));var g=new Array();for(var n=0;n<h.length;n++){if(h[n].Upstream!=""&&h[n].Upstream!=null){if(h[n].LevelId!="1"){g.push(h[n].LevelName)}else{c+='<div class="line" style="height:'+he2+'px"></div>';$("#downst").html(h[n].LevelName)}}else{if(h[n].LevelId!="1"&&h[n].LevelId!=a){d+='<div class="st"><div style="margin-left:-180px; width:175px;  text-align:right  ">'+h[n].LevelName+"</div></div>";d+='<div class="line" style="height:'+he1+'px"></div>'}else{if(h[n].LevelId=="1"){d+='<div class="line" style="height:'+he1+'px"></div>';$("#upst").html(h[n].LevelName)}}}}for(var k=g.length-1;k>=0;k--){if(k!=g.length-1){c+='<div class="st"><div style="margin-left:20px; width:175px;  text-align:left ">'+g[k]+"</div></div>";c+='<div class="line" style="height:'+he2+'px"></div>'}}if(d!=""&&c!=""){$("#up").html(d);$("#down").html(c);e=true;$("#showModule").show();$("#loading").fadeOut()}else{$("#RefreshM").show();$("#showModule").hide();e=false}}else{e=false}}});return e}var vlist={};function TogetAll(){var d=0;var c="";var b="";var a="ajax/controller.php?Method=gpsdata&roadline="+RoadLine;$.get(a,function(g){if(g==null||g==""||g==undefined){$("#RefreshM").show();$("#showModule").hide();return false}var g=$.parseJSON(g);var f=g.data;if(f.length>0){for(var e=0;e<f.length;e++){var h="http://116.236.170.106:9001/MobileWeb/ShowData.aspx?which=ad&roadline=&registrationmark=&VehicleNumbering=&AdContent="+f[e].Adcode;c+='<div  id="'+f[e].vnumber+'"  class="dnone" > <div class="tit" onclick="showContent(\''+f[e].vnumber+"')\" >"+f[e].vnumber+'</div>  <div class="stit" onclick="showContent(\''+f[e].vnumber+"')\" ></div></div>";c+=' <div  id="d'+f[e].vnumber+'" class="dnone" style=" width:225px; border:1px solid black;  background-color:white;  z-index:10000; height:133px;  ">';c+='<table border="0" style=" width:100%;text-align: left;"  >';c+="                 <tr><td></td><td></td></tr>";c+='                 <tr><td style=" width:40%">自编号</td><td>'+f[e].vnumber+"["+f[e].vid+"]</td></tr>";c+="                 <tr><td>车速</td><td>"+f[e].Speed+"km/h</td></tr>";c+="                  <tr><td>下一站位置</td><td>"+f[e].wz+"</td></tr>";c+="                 <tr><td>定位时间</td><td>"+f[e].DWTime+"</td></tr>";c+="                 <tr><td>预计到达</td><td>"+f[e].dzsj+"</td></tr>";c+="                 <tr><td>班次信息</td><td>"+f[e].drivername+"</td></tr>";c+="           </table>";c+="       </div>"}d=g.busCount;$("#park").html(c)}else{}if(d<2){}})}var hisid="";function showContent(a){if(hisid!=a){$("#d"+a).removeClass("dnone");$("#d"+hisid).addClass("dnone");$("#dd"+hisid1).addClass("dnone");hisid=a}else{$("#d"+a).addClass("dnone");hisid=""}}var hisid1="";function showContent1(a){if(hisid1!=a){$("#dd"+a).removeClass("dnone");$("#dd"+hisid1).addClass("dnone");$("#d"+hisid).addClass("dnone");hisid1=a}else{$("#dd"+a).addClass("dnone");hisid1=""}}$(document).mouseup(function(b){var a=$("body");if(!a.is(b.target)&&a.has(b.target).length<=1){$("#dd"+hisid1).addClass("dnone");$("#d"+hisid).addClass("dnone");hisid=""}});var mg=0;var isFirst=false;function Move(){if(isFirst){if((new Date().getSeconds())%5!=0){return}}isFirst=true;getScreen();var a=0;var f=13;var g="";var e="";var c=0;var h="";var b="";var d="ajax/controller.php?Method=gpsdata&roadline="+RoadLine;$.ajax({url:d,type:"GET",dataType:"text",cache:false,timeout:8000,error:function(){},success:function(p){vlist={};var k=0;if(p==null||p==""||p==undefined){$("#RefreshM").show();
$("#showModule").hide();return false}var p=$.parseJSON(p);var l=p.data;if(l.length>0){for(var q=0;q<l.length;q++){c=0;var t="http://116.236.170.106:9001/MobileWeb/ShowData.aspx?which=ad&roadline=&registrationmark=&VehicleNumbering=&AdContent="+l[q].Adcode;if(l[q].state=="营运车辆"){a++;if(l[q].todir=="0"){if(parseInt(l[q].nextlevel)-1>0){c=he1*(parseInt(l[q].nextlevel)-2)+f*(parseInt(l[q].nextlevel)-2)+parseInt(he1*l[q].rate)}else{c=parseInt(he1*l[q].rate)}if(parseInt(l[q].stationid)>-1){if(parseInt(l[q].stationid)==2){c=he1}else{c=he1*(parseInt(l[q].stationid)-1)+f*(parseInt(l[q].stationid)-2)}$("#"+l[q].vnumber).removeClass("dnone").removeClass("point1").addClass("upInSt").css("margin-top",(c)+"px");$("#"+l[q].vnumber).find(".tit").addClass("leftst").html(l[q].vnumber);$("#d"+l[q].vnumber).addClass("leftdi").css("margin-top",c+"px")}else{c+=parseInt(he1*l[q].rate);$("#"+l[q].vnumber).removeClass("dnone").removeClass("upInSt").addClass("point1").css("margin-top",c+"px");$("#"+l[q].vnumber).find(".tit").addClass("leftst").html(l[q].vnumber);$("#d"+l[q].vnumber).addClass("leftdi").css("margin-top",c+"px")}k=c}else{if(parseInt(l[q].nextlevel)-1>0){var n=parseInt(l[q].nextlevel);if(n>=2&&n<$("#down .st").length+2){c=$("#down .st:eq("+($("#down .st").length-parseInt(l[q].nextlevel)+1)+")").offset().top-$("#down").offset().top+he2}}else{c=parseInt(he2*l[q].rate)}if(parseInt(l[q].stationid)>-1){if(parseInt(l[q].stationid)==2){c=he2}else{c=he2*(parseInt(l[q].nextlevel)-1)+f*(parseInt(l[q].stationid))}$("#"+l[q].vnumber).removeClass("dnone").removeClass("point2").addClass("downInSt").css("margin-top",(c)+"px");$("#"+l[q].vnumber).find(".tit").addClass("rightst").html(l[q].vnumber);$("#"+l[q].vnumber).find(".stit").addClass("rightst").html(l[q].vid);$("#d"+l[q].vnumber).addClass("rightdi").css("margin-top",(c)+"px")}else{c+=parseInt(he2*l[q].rate);$("#"+l[q].vnumber).removeClass("dnone").removeClass("downInSt").addClass("point2").css("margin-top",(c)+"px");$("#"+l[q].vnumber).find(".tit").addClass("rightst").html(l[q].vnumber);$("#d"+l[q].vnumber).addClass("rightdi").css("margin-top",(c)+"px")}k=c}$("#d"+l[q].vnumber+" table").find("tr:eq(2)").find("td:eq(1)").text(l[q].Speed+"km/h");$("#d"+l[q].vnumber+" table").find("tr:eq(3)").find("td:eq(1)").text(l[q].wz);$("#d"+l[q].vnumber+" table").find("tr:eq(4)").find("td:eq(1)").text(l[q].DWTime);$("#d"+l[q].vnumber+" table").find("tr:eq(5)").find("td:eq(1)").text(l[q].dzsj);$("#d"+l[q].vnumber+" table").find("tr:eq(6)").find("td:eq(1)").text(l[q].drivername);vlist[l[q].vnumber]=c;var u=parseInt($("#"+l[q].vnumber).css("left"));if(isNaN(u)){u=parseInt($("#"+l[q].vnumber).css("right"))}var j=0;for(var o in vlist){$("#d"+o).addClass("dnone");var s=parseInt($("#"+o).css("left"));if(isNaN(s)){s=parseInt($("#"+o).css("right"))}var r=parseInt($("#"+o).css("marginTop"));if(r<=(k+10)&&r>=(k-10)&&u==s&&!isNaN(s)){$("#"+o).find(".tit").css("margin-top",(j));$("#d"+o).css("margin-top",(k+j));j+=10}}}else{if(l[q].state==getfirst){$("#"+l[q].vnumber).addClass("dnone");$("#"+l[q].vnumber).removeClass("point2");$("#"+l[q].vnumber).find(".tit").removeClass("rightst");if(h==""){h+=(l[q].vnumber==vn0?"<span class='redcolor' onclick='showContent1(\""+l[q].vnumber+"\")'  >"+l[q].vnumber+"</span>":"<span   onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>");h+=' <div  id="dd'+l[q].vnumber+'"  class="dnone" style=" width:220px; border:1px solid black;  background-color:white;  z-index:1000; height:110px; position: absolute;   ">';h+='<table border="0" style=" width:100%;text-align: left;">';h+="                 <tr><td></td><td></td></tr>";h+='              <tr><td style=" width:40%">自编号</td><td>'+l[q].vnumber+"["+l[q].vid+"]</td></tr>";h+="                 <tr><td>车速</td><td>"+l[q].Speed+"km/h</td></tr>";h+="                  <tr><td>下一站位置</td><td>"+l[q].wz+"</td></tr>";h+="                 <tr><td>定位时间</td><td>"+l[q].DWTime+"</td></tr>";h+="                 <tr><td>司机信息</td><td>"+l[q].drivername+"</td></tr>";h+="           </table>";h+="       </div>"}else{h+=","+(l[q].vnumber==vn0?"<span class='redcolor'   onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>":"<span   onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>");h+=' <div  id="dd'+l[q].vnumber+'"  class="dnone" style=" width:220px; border:1px solid black;  background-color:white;  z-index:1000; height:110px; position: absolute; ">';h+='<table border="0" style=" width:100%;text-align: left;">';h+="                 <tr><td></td><td></td></tr>";h+='              <tr><td style=" width:40%">自编号</td><td>'+l[q].vnumber+"["+l[q].vid+"]</td></tr>";h+="                 <tr><td>车速</td><td>"+l[q].Speed+"km/h</td></tr>";h+="                  <tr><td>下一站位置</td><td>"+l[q].wz+"</td></tr>";h+="                 <tr><td>定位时间</td><td>"+l[q].DWTime+"</td></tr>";h+="                 <tr><td>司机信息</td><td>"+l[q].drivername+"</td></tr>";h+="           </table>";h+="       </div>"}a++}else{if(l[q].state==getlast){$("#"+l[q].vnumber).addClass("dnone");
$("#"+l[q].vnumber).removeClass("point1");$("#"+l[q].vnumber).find(".tit").removeClass("leftst");if(b==""){b+=(l[q].vnumber==vn1?"<span class='redcolor'  onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>":"<span  onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>");b+=' <div  id="dd'+l[q].vnumber+'"  class="dnone"   style=" width:220px; border:1px solid black;  background-color:white;  z-index:1000; height:110px;position: absolute;  top:-150px  ">';b+='<table border="0" style=" width:100%;text-align: left;">';b+="                  <tr><td></td><td></td></tr>";b+='              <tr><td style=" width:40%">自编号</td><td>'+l[q].vnumber+"["+l[q].vid+"]</td></tr>";b+="                 <tr><td>车速</td><td>"+l[q].Speed+"km/h</td></tr>";b+="                  <tr><td>下一站位置</td><td>"+l[q].wz+"</td></tr>";b+="                 <tr><td>定位时间</td><td>"+l[q].DWTime+"</td></tr>";b+="                 <tr><td>司机信息</td><td>"+l[q].drivername+"</td></tr>";b+="           </table>";b+="       </div>"}else{b+=","+(l[q].vnumber==vn1?"<span class='redcolor'  onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>":"<span  onclick='showContent1(\""+l[q].vnumber+"\")'>"+l[q].vnumber+"</span>");b+=' <div  id="dd'+l[q].vnumber+'" class="dnone"   style=" width:220px; border:1px solid black;  background-color:white;  z-index:1000; height:110px;  position: absolute; top:-150px " >';b+='<table border="0" style=" width:100%;text-align: left;">';b+="                  <tr><td></td><td></td></tr>";b+='              <tr><td style=" width:40%">自编号</td><td>'+l[q].vnumber+"["+l[q].vid+"]</td></tr>";b+="                 <tr><td>车速</td><td>"+l[q].Speed+"km/h</td></tr>";b+="                  <tr><td>下一站位置</td><td>"+l[q].wz+"</td></tr>";b+="                 <tr><td>定位时间</td><td>"+l[q].DWTime+"</td></tr>";b+="                 <tr><td>司机信息</td><td>"+l[q].drivername+"</td></tr>";b+="           </table>";b+="       </div>"}a++}else{if(l[q].state=="报站"){$("#"+l[q].vnumber).removeClass("dnone")}else{$("#"+l[q].vnumber).addClass("dnone");$("#"+l[q].vnumber).removeClass("point1");$("#"+l[q].vnumber).find(".tit").removeClass("leftst");$("#"+l[q].vnumber).removeClass("point2");$("#"+l[q].vnumber).find(".tit").removeClass("rightst")}}}}if(revid==l[q].vid){$("#"+l[q].vnumber).css("color","aqua")}}$("#lastup").html(h);$("#lastdown").html(b);$("#showModule").show();if(hisid!=""){$("#d"+hisid).removeClass("dnone")}$("#loading").fadeOut()}else{}}})}function check(a){}function getMinVa(a){while(a%2>0||a%3>0||a%5>0){if(a%2>0){a=a/2}else{if(a%3>0){a=a/3}else{if(a%5>0){a=a/5}else{break}}}}return a}function getScreen(){var a="ajax/controller.php?roadline="+RoadLine+"&Method=departscreen&startstation=all";$.ajax({url:a,type:"GET",dataType:"text",cache:false,timeout:5000,error:function(){return},success:function(d){var d=$.parseJSON(d);if(d.jhpc!=undefined){$("#busCount").text(d.jhpc)}if(d.dqyy!=undefined){$("#lineCount").text(d.dqyy)}var c=d.data;if(c.length>0){for(var b=0;b<c.length;b++){if(c[b].dir=="0"){$("#plan1").html(parseInt(c[b].jhjg));$("#dplan1").html(parseInt(c[b].yjjg));vn0=c[0].VEHICLENUMBERING;$("#vnup1").html(vn0);$("#timeup1").html(c[b].PLANTIME)}else{$("#plan2").html(parseInt(c[b].jhjg));$("#dplan2").html(parseInt(c[b].yjjg));vn1=c[b].VEHICLENUMBERING;$("#vndown1").html(vn1);$("#timedown1").html(c[b].PLANTIME)}}}}})}function getStartScreen(){var d=0;var c="";var b="";var a="interface/Handler.ashx?action=departscreen&userid=test&password=test&roadline="+RoadLine+"&startstation=all&format=xml";$.get(a,function(e){$(e).find("result").each(function(f){var g=$(this);if(g.attr("dir")=="1"){$("#plan1").html(g.find("jhjg").text());$("#dplan1").html(g.find("yjjg").text());vn0=g.find("Current").find("vnumber").text();$("#vnup1").html(vn0);$("#timeup1").html(g.find("Current").find("depart").text())}else{if(g.attr("dir")=="0"){$("#plan2").html(g.find("jhjg").text());$("#dplan2").html(g.find("yjjg").text());vn1=g.find("Current").find("vnumber").text();$("#vndown1").html(vn1);$("#timedown1").html(g.find("Current").find("depart").text())}}})})}function getWorkBus(){var a="Ajax/Handler.ashx?Method=workBus&roadline="+RoadLine;$.get(a,function(b){$("#WorkCount").html(b)})};
